# MCP Server for NKO (Non-Profit Organizations)

Этот MCP сервер предоставляет доступ к данным НКО (некоммерческих организаций) через Model Context Protocol, обращаясь к бэкенд API по адресу `backend:8000/nko`. Сервер включает два компонента:

1. **mcp.py** - MCP сервер для интеграции с MCP-совместимыми клиентами
2. **main.py** - Интерактивное приложение с использованием OpenRouter API для обработки естественного языка

## Функциональность

### MCP Сервер (mcp.py)

Сервер предоставляет следующие инструменты (tools):

#### 1. get_nko_list
Получение списка НКО с возможностью фильтрации.

**Параметры:**
- `jwt_token` (string, опционально): JWT токен для аутентификации (требуется только для фильтра по избранному)
- `city` (string, опционально): Фильтр по названию города
- `favorite` (boolean, опционально): Фильтр по статусу "избранное" (требует jwt_token)
- `category` (array of strings, опционально): Фильтр по категориям (можно указать несколько)
- `regex` (string, опционально): Регулярное выражение для поиска в названии и описании

#### 2. get_nko_by_id
Получение конкретной НКО по её ID.

**Параметры:**
- `nko_id` (integer, обязательно): ID НКО для получения

#### 3. get_cities
Получение списка всех доступных городов с опциональной фильтрацией.

**Параметры:**
- `regex` (string, опционально): Регулярное выражение для фильтрации названий городов

### Интерактивное приложение (main.py)

Приложение использует OpenRouter API для обработки пользовательских запросов на естественном языке и предоставляет персонализированные рекомендации НКО.

**Примеры запросов:**
- "Хочу сходить куда-нибудь в Москве"
- "Ищу благотворительную организацию для помощи детям"
- "Посоветуйте НКО в Санкт-Петербурге, занимающиеся образованием"

**Как работает:**
1. Приложение извлекает город и категории из запроса пользователя с помощью OpenRouter
2. Получает релевантные данные НКО из бэкенд API
3. Генерирует персонализированный ответ с рекомендациями

## Установка и запуск

### С помощью Docker Compose

1. Убедитесь, что у вас установлен Docker и Docker Compose
2. Перейдите в директорию `deploy`
3. Убедитесь, что в файле `.env` указан ваш `OPENROUTER_API_KEY`
4. Запустите все сервисы командой:
   ```bash
   docker-compose up -d
   ```

MCP сервер будет доступен как сервис `nko-mcp-server` в сети Docker.

### Локальный запуск

1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

2. Создайте файл `.env` с переменными окружения:
   ```bash
   cp .env.example .env
   ```
   
   И отредактируйте его, указав:
   ```
   BACKEND_URL=http://localhost:8000
   OPENROUTER_API_KEY=your_openrouter_api_key_here
   ```

3. Запустите интерактивное приложение:
   ```bash
   python main.py
   ```

4. Или запустите только MCP сервер:
   ```bash
   python mcp.py
   ```

## Использование

### HTTP API (server.py)

После запуска через Docker Compose, API будет доступен по адресу `http://localhost/ai/`.

#### Эндпоинт API:

**POST /ai/query** - Обработка пользовательского запроса с помощью OpenRouter
```json
{
  "query": "Хочу сходить куда-нибудь в Москве",
  "jwt_token": "опциональный JWT токен"
}
```

#### Пример использования с curl:

```bash
# Обработать запрос
curl -X POST http://localhost/ai/query \
  -H "Content-Type: application/json" \
  -d '{"query": "Хочу сходить куда-нибудь в Москве"}'

# Обработать запрос с JWT токеном
curl -X POST http://localhost/ai/query \
  -H "Content-Type: application/json" \
  -d '{"query": "Посоветуй НКО для помощи детям", "jwt_token": "your_jwt_token"}'
```

#### Тестирование:

Для тестирования API можно использовать готовый скрипт:
```bash
./test_curls.sh
```

### Интерактивное приложение (main.py)

После запуска `python main.py` вы сможете вводить запросы на естественном языке:

```
Введите ваш запрос (или 'выход' для завершения): Хочу сходить куда-нибудь в Москве

Обрабатываю ваш запрос...

Ответ:
На основе вашего запроса о посещении мест в Москве, я могу порекомендовать следующие некоммерческие организации:

1. [Название НКО]
   Описание: [Краткое описание]
   Адрес: [Адрес]
   Категории: [Категории]

2. [Название НКО]
   Описание: [Краткое описание]
   Адрес: [Адрес]
   Категории: [Категории]

...
```

### Использование с MCP клиентами

MCP сервер (`mcp.py`) работает через stdio и может быть использован с любым MCP-совместимым клиентом.

#### Пример использования с Claude Desktop

Добавьте в конфигурацию Claude Desktop:

```json
{
  "mcpServers": {
    "nko-server": {
      "command": "docker",
      "args": ["exec", "-i", "nko-mcp-server", "python", "mcp.py"]
    }
  }
}
```

#### Примеры запросов к MCP серверу

1. Получить все НКО:
   ```
   Используй инструмент get_nko_list без параметров
   ```

2. Получить НКО в определённом городе:
   ```
   Используй инструмент get_nko_list с параметром city="Москва"
   ```

3. Получить НКО по категориям:
   ```
   Используй инструмент get_nko_list с параметром category=["Помощь детям", "Образование"]
   ```

4. Получить конкретную НКО по ID:
   ```
   Используй инструмент get_nko_by_id с параметром nko_id=1
   ```

5. Получить список городов:
   ```
   Используй инструмент get_cities
   ```

## Архитектура

Система состоит из двух компонентов:

1. **MCP сервер (mcp.py)**: Работает как прокси между MCP клиентом и бэкенд API:
   - MCP клиент → MCP сервер → Backend API → База данных

2. **Интерактивное приложение (main.py)**: Использует OpenRouter API для обработки естественного языка:
   - Пользователь → OpenRouter API → Извлечение параметров → Backend API → База данных
   - База данных → Backend API → OpenRouter API → Персонализированный ответ

Это позволяет использовать существующую логику бэкенда без дублирования кода.

## Зависимости

- mcp: Библиотека Model Context Protocol
- httpx: HTTP клиент для асинхронных запросов
- python-dotenv: Загрузка переменных окружения из .env файла
- openai: Клиент для OpenRouter API

## Логирование

Сервер использует стандартный модуль logging для вывода информации о работе и ошибках.

## Требования

- Доступ к бэкенд API по адресу `http://backend:8000` (или другому, указанному в `BACKEND_URL`)
- API ключ для OpenRouter (указывается в переменной окружения `OPENROUTER_API_KEY`)